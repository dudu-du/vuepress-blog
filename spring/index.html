<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring学习笔记 | 追求卓越，成功会在不经意间追上你</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/docs/favicon.ico">
    <meta name="description" content="追求卓越，成功会在不经意间追上你">
    
    <link rel="preload" href="/docs/assets/css/0.styles.ab7a6878.css" as="style"><link rel="preload" href="/docs/assets/js/app.5a0d12c5.js" as="script"><link rel="preload" href="/docs/assets/js/2.e7fbde6b.js" as="script"><link rel="preload" href="/docs/assets/js/9.499b8aef.js" as="script"><link rel="prefetch" href="/docs/assets/js/3.1d2bffe0.js"><link rel="prefetch" href="/docs/assets/js/4.e58f9b9b.js"><link rel="prefetch" href="/docs/assets/js/5.41fed955.js"><link rel="prefetch" href="/docs/assets/js/6.6748e3a0.js"><link rel="prefetch" href="/docs/assets/js/7.efe41c78.js"><link rel="prefetch" href="/docs/assets/js/8.28fe212e.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.ab7a6878.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><!----> <span class="site-name">追求卓越，成功会在不经意间追上你</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/docs/spring/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Spring
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/language/chinese/" class="nav-link">
  Chinese
</a></li><li class="dropdown-item"><!----> <a href="/docs/language/japanese/" class="nav-link">
  Japanese
</a></li><li class="dropdown-item"><h4>
          Group1
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/docs/language/chinese/" class="nav-link">
  Chinese
</a></li><li class="dropdown-subitem"><a href="/docs/language/japanese/" class="nav-link">
  Japanese
</a></li></ul></li><li class="dropdown-item"><h4>
          Group2
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/docs/language/chinese/" class="nav-link">
  Chinese
</a></li><li class="dropdown-subitem"><a href="/docs/language/japanese/" class="nav-link">
  Japanese
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/docs/spring/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Spring
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/language/chinese/" class="nav-link">
  Chinese
</a></li><li class="dropdown-item"><!----> <a href="/docs/language/japanese/" class="nav-link">
  Japanese
</a></li><li class="dropdown-item"><h4>
          Group1
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/docs/language/chinese/" class="nav-link">
  Chinese
</a></li><li class="dropdown-subitem"><a href="/docs/language/japanese/" class="nav-link">
  Japanese
</a></li></ul></li><li class="dropdown-item"><h4>
          Group2
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/docs/language/chinese/" class="nav-link">
  Chinese
</a></li><li class="dropdown-subitem"><a href="/docs/language/japanese/" class="nav-link">
  Japanese
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Spring学习笔记</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/spring/#_1-ioc容器源码解析" class="sidebar-link">1. IOC容器源码解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/spring/#_1-1-beandefinition" class="sidebar-link">1.1 BeanDefinition</a></li><li class="sidebar-sub-header"><a href="/docs/spring/#_1-2-beanfactory【简单容器】" class="sidebar-link">1.2 BeanFactory【简单容器】</a></li><li class="sidebar-sub-header"><a href="/docs/spring/#_1-3-applicationcontext【高级容器】" class="sidebar-link">1.3 ApplicationContext【高级容器】</a></li><li class="sidebar-sub-header"><a href="/docs/spring/#_1-4-resource、resourceloader" class="sidebar-link">1.4. Resource、ResourceLoader</a></li><li class="sidebar-sub-header"><a href="/docs/spring/#_1-5-beandefinitionreader" class="sidebar-link">1.5 BeanDefinitionReader</a></li><li class="sidebar-sub-header"><a href="/docs/spring/#_1-6-beandefinitionregistry" class="sidebar-link">1.6 BeanDefinitionRegistry</a></li><li class="sidebar-sub-header"><a href="/docs/spring/#_1-7-beandefinition注册流程" class="sidebar-link">1.7 BeanDefinition注册流程</a></li><li class="sidebar-sub-header"><a href="/docs/spring/#_1-8-xml配置文件加载beandefinition流程" class="sidebar-link">1.8 xml配置文件加载BeanDefinition流程</a></li><li class="sidebar-sub-header"><a href="/docs/spring/#_1-9-注解配置加载beandefinition流程" class="sidebar-link">1.9 注解配置加载BeanDefinition流程</a></li></ul></li><li><a href="/docs/spring/#_2-refresh-方法" class="sidebar-link">2. Refresh()方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/spring/#_2-1-postprocessor" class="sidebar-link">2.1 PostProcessor</a></li><li class="sidebar-sub-header"><a href="/docs/spring/#_2-2-aware接口" class="sidebar-link">2.2 Aware接口</a></li><li class="sidebar-sub-header"><a href="/docs/spring/#_2-3-事件监听器模式" class="sidebar-link">2.3 事件监听器模式</a></li><li class="sidebar-sub-header"><a href="/docs/spring/#_2-4-refresh-方法流程" class="sidebar-link">2.4 refresh()方法流程</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="_1-ioc容器源码解析"><a href="#_1-ioc容器源码解析" class="header-anchor">#</a> 1. IOC容器源码解析</h2> <p><img src="/assets/img/spring/image-20220425080658717.png" alt="image-20220425080658717"></p> <h3 id="_1-1-beandefinition"><a href="#_1-1-beandefinition" class="header-anchor">#</a> 1.1 BeanDefinition</h3> <blockquote><p>https://cloud.tencent.com/developer/article/1497805</p></blockquote> <ul><li><p>Bean是Spring的一等公民</p></li> <li><p>可以把BeanDefinition类比为Java中的Class，Java中用Class描述Java类并制作对象实例，而在Spring中，通过BeanDefinition来描述并制作Bean</p></li> <li><p>在BeanDefinition中，包含了有别于Java对象的额外属性，如下👇</p></li></ul> <table><thead><tr><th style="text-align:center;">额外属性</th> <th style="text-align:center;">XML方式</th> <th style="text-align:center;">注解方式</th> <th style="text-align:center;">描述</th></tr></thead> <tbody><tr><td style="text-align:center;">作用范围</td> <td style="text-align:center;">scope</td> <td style="text-align:center;">@Scope</td> <td style="text-align:center;">singleton、prototype、request、session、globalsession</td></tr> <tr><td style="text-align:center;">懒加载</td> <td style="text-align:center;">lazy-init</td> <td style="text-align:center;">@Lazy</td> <td style="text-align:center;">第一次使用的时候才会创建出bean的实例</td></tr> <tr><td style="text-align:center;">首选</td> <td style="text-align:center;">primary</td> <td style="text-align:center;">@Primary</td> <td style="text-align:center;">设置为true的bean会是优先的实现类</td></tr> <tr><td style="text-align:center;">工厂Bean<br>工厂方法</td> <td style="text-align:center;">factory-bean<br>factory-method</td> <td style="text-align:center;">@Configuration<br>@Bean</td> <td style="text-align:center;">如下图，</td></tr></tbody></table> <p><img src="/assets/img/spring/image-20220425075431872.png" alt="image-20220425075431872"></p> <img src="/assets/img/spring/image-20220425080738344.png" alt="image-20220425080738344" style="zoom:40%;"> <ul><li><p><code>AttributeAccessor</code></p> <ul><li>定义了最基本的对任意对象元数据的修改或者获取方式</li> <li>BeanDefinition继承了他，用于获取BeanDefinition的属性，并对这些属性进行操作</li></ul></li> <li><p><code>BeamMetadataElement</code></p> <ul><li>提供了一个<code>getResource()</code>方法</li> <li>用来传输一个可以配置的源对象，对于BeanDefinition来说，用来返回它的Class对象？？？</li></ul></li> <li><p><code>AttributeAccessorSupport</code></p> <ul><li>AttributeAccessor的简单实现</li> <li>定义了一个LinkedHashMap，用于存储某个对象的元数据</li></ul></li> <li><p><code>AbstractBeanDefinition</code></p> <blockquote><p>经验：在编写代码过程中，如果涉及到多个实现子类，并且多个实现子类之间有许多通用部分，可以将这些通用部分放到一个抽象类中</p></blockquote> <ul><li>BeanDefinition实现类的基类</li> <li>定义了一个通用的构造函数<code>AbstractBeanDefinition(BeanDefinition original)</code>，为指定的BeanDefinition做深度拷贝【定义了一些通用的属性和getter、setter方法，方便赋值】，factoryBean和factoryMethod也在这里设置</li> <li>公共的工具方法
<ul><li><code>overrideFrom(BeanDefinition other)</code>：用别的BeanDefinition的属性全量覆盖当前BeanDefinition</li> <li><code>applyDefaults(BeanDefinitionDefaults defaults)</code>：为当前BeanDefinition设置初始值</li></ul></li></ul></li> <li><p><code>RootBeanDefinition</code></p> <ul><li>BeanDefinition之间的继承关系是通过设置pairentName属性来决定的</li> <li>可以单独作为BeanDefinition，也可以作为其他BeanDefinition的父类，但是不能作为其他BeanDefinition的子类，如果为他设置parentName，会抛出异常</li> <li>RootBeanDefinition用来在运行时接收多个BeanDefinition合并起来的信息</li> <li>配置文件里的Bean标签会被解析成RootBeanDefinition，Spring2.5之后使用了GenericBeanDefinition取代了RootBeanDefinition和ChildBeanDefinition</li></ul></li> <li><p><code>ChildBeanDefinition</code></p> <ul><li>不可以单独存在，必须依赖一个父BeanDefinition，已经完全被GenericBeanDefinition取代了</li></ul></li> <li><p><code>GenericBeanDefinition</code></p> <ul><li>Spring2.5之后，新加入的Bean文件配置属性定义类，是ChildBeanDefinition和RootBeanDefinition更好的替代方案</li> <li>在AbstractBeanDefinition基础上增加了parentName属性，其他基本没变</li></ul></li></ul> <h3 id="_1-2-beanfactory【简单容器】"><a href="#_1-2-beanfactory【简单容器】" class="header-anchor">#</a> 1.2 BeanFactory【简单容器】</h3> <blockquote><p>BeanFactory是SpringIOC容器的根接口，定义了bean工厂最基础的功能特性</p> <p>Bean都是由它的实现类来管理的</p></blockquote> <ul><li><p>主要方法</p> <ul><li>getBean(String name)</li> <li>getBean(Class type)</li> <li>isSingleton(String name)</li> <li>isPrototype(String name)</li> <li>getType(String name)</li> <li>getAliases(String name)</li></ul></li> <li><p>在<code>BeanFactory</code>接口中定义了一个变量</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 用来获取FactoryBean的实例</span>
<span class="token class-name">String</span> FACTORY_BEAN_PREFIX <span class="token operator">=</span> <span class="token string">&quot;&amp;&quot;</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p><code>FactoryBean</code>接口</p> <ul><li><code>getObject()</code> - 用户可以通过一套复杂的逻辑来生成bean</li> <li>本质也是一个bean，用来生成普通的bean</li> <li>容器初始化的时候，会把实现了这个接口的bean取出来，使用bean里面的getObject()方法来生成我们想要的bean</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserFactoryBean</span> <span class="token keyword">implements</span> <span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">getObjectType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userFactoryBean<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.zhaoxuan.entity.factory.UserFactoryBean<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;userFactoryBean&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// com.zhaoxuan.entity.User@239963d8</span>
<span class="token comment">// 返回的是User实例</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">UserFactoryBean</span> userFactoryBean <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserFactoryBean</span><span class="token punctuation">)</span> context
        <span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">BeanFactory</span><span class="token punctuation">.</span>FACTORY_BEAN_PREFIX <span class="token operator">+</span> <span class="token string">&quot;userFactoryBean&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// com.zhaoxuan.entity.factory.UserFactoryBean@3abbfa04</span>
<span class="token comment">// 返回的是factoryBean实例</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userFactoryBean<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><img src="/assets/img/spring/image-20220425182311945.png" alt="image-20220425182311945" style="zoom:40%;"></li> <li><p>单一职责，每个较顶层接口都是单一职责的，只提供某一方面的功能</p></li> <li><p><code>ListableBeanFactory</code></p> <ul><li>以列表的形式提供bean的相关信息</li> <li>最大的特点就是批量列出工厂生产的实例的信息【getBeanDefinitionNames()】</li></ul></li> <li><p><code>HierarchicalBeanFactory</code></p> <blockquote><p>允许BeanFactory进行分层</p></blockquote> <ul><li>getParentBeanFactory() - 如果有父工厂，则返回</li> <li>containsLocalBean(String name) - 本层是否包含某个bean，不会在父工厂查找</li> <li>实现了该接口的容器，可以在应用中启动多个BeanFactory，将各个BeanFactory设置为父子关系，这样能很好适配三层架构了，比如容器A管理Controller层的bean，容器B管理Service层的bean......</li></ul></li> <li><p><code>AutowireCapableBeanFactory</code></p> <ul><li>给容器赋予了自动装配bean的能力，根据BeanDefinition去装配bean，执行前后处理器</li> <li>集成其他框架的时候，该接口的实现类例如<code>AbstractAutowireCapableBeanFactory</code>，通过他的autowireBean方法里面的populateBean方法去把其他框架的实例注册到IOC容器中</li> <li>@Autowired的处理逻辑最终调用了<code>AutowireCapableBeanFactory</code>的<code>resolveDependency(DependencyDescriptor descriptor, @Nullable String requestingBeanName)</code>实现的依赖注入</li> <li>5种装配策略
<ul><li>0 - 没有自动装配</li> <li>1 - 根据名称</li> <li>2 - 根据类型 - @Autowired使用</li> <li>3 - 根据构造函数</li> <li>4 - Spring3.0废弃</li></ul></li> <li>还定义了一些跟自动装配相关的方法以及执行BeanPostProcessor的方法</li></ul></li> <li><p><code>ConfigurableBeanFactory</code></p> <ul><li>设置父容器、类加载器、属性编辑器、容器通用的后置处理器等方法</li> <li>继承了<code>SingletonBeanRegistry</code>，提供了在运行期间向容器注册单例实例bean的能力</li></ul></li> <li><p><code>ConfigurableListableBeanFactory</code></p> <ul><li>整合了BeanFactory体系的所有二级接口，包含了BeanFactory体系的所有方法</li> <li>加入了诸如忽略自动装配等10个方法</li></ul></li> <li><p><code>DefaultListableBeanFactory</code></p> <ul><li>第一个真正可以独立运行的IOC容器</li> <li>实现了BeanDefinitionRegistry接口</li> <li>最关键的成员变量beanDefinitionMap，Spring中有两个地方定义了beanDefinitionMap，另外一个是<code>SimpleBeanDefinitionRegistry</code>，只提供注册表功能，并无工厂功能</li> <li>ApplicationContext最终实现子类里，由于对BeanDefinition进行注册是一项必须具备的需求，所以他们会以组合的方式去调用DefaultListableBeanFactory提供的registerBeanDefinition方法对BeanDefinition进行注册</li></ul></li></ul> <h3 id="_1-3-applicationcontext【高级容器】"><a href="#_1-3-applicationcontext【高级容器】" class="header-anchor">#</a> 1.3 ApplicationContext【高级容器】</h3> <img src="/assets/img/spring/image-20220425182433330.png" alt="image-20220425182433330" style="zoom:50%;"> <ul><li><p><code>ApplicationContext</code></p> <blockquote><p>EnvironmentCapable、ListableBeanFactory、HierarchicalBeanFactory、MessageSource、ApplicationEventPublisher、ResourcePatternResolver</p></blockquote></li> <li><p>传统基于XML配置的经典容器</p> <ul><li><code>FileSystemXmlApplicationContext</code></li> <li><code>ClassPathXmlApplication</code></li> <li><code>XmlWebApplicationContext</code> - 用于web应用程序的容器</li></ul></li> <li><p>目前比较流行的</p> <ul><li><code>AnnotationConfigServletWebServerApplicationContext</code> - 在springboot的boot模块下</li> <li><code>AnnotationConfigReactiveWebServerApplicationContext</code> - 在springboot的boot模块下</li> <li><code>AnnotationConfigApplicationContext</code></li></ul></li> <li><p>上述容器的共同点 ----- refresh()方法</p></li> <li><p><code>ConfigurableApplicationContext</code></p> <ul><li>继承<code>LifeCycle</code>、<code>Closeable</code>用于对容器的生命周期管理和资源的释放</li> <li>主要两个方法refresh和close，让ApplicationContext具备启动刷新、关闭应用上下文的能力</li></ul></li> <li><p><code>AbstractApplicationContext</code></p> <ul><li>Spring高级容器中最重要的类</li> <li>继承了DefaultResourceLoader</li> <li>事件发送广播、监听器注册、getBean方法实现、refresh</li></ul></li></ul> <h3 id="_1-4-resource、resourceloader"><a href="#_1-4-resource、resourceloader" class="header-anchor">#</a> 1.4. Resource、ResourceLoader</h3> <img src="/assets/img/spring/image-20220425201249587.png" alt="image-20220425201249587" style="zoom:50%;"> <ul><li><p><code>EncodedResource</code></p> <ul><li>实现对资源文件的编码处理</li> <li>getReader</li></ul></li> <li><p><code>AbstractResource</code></p></li> <li><p><code>ServletContextResource</code></p></li> <li><p><code>ClassPathResource</code></p> <ul><li>利用相对路径的方式访问WEB-INF/classes类路径下的资源</li></ul></li> <li><p><code>FileSystemResource</code></p></li> <li><p>Spring提供了强大的加载资源方式</p> <ul><li>自动识别“classpath:”、“file:”等资源地址前缀</li> <li>支持自动解析Ant风格带通配符的资源地址</li></ul></li> <li><p>Ant</p> <ul><li>路径匹配表达式，用来对uri进行匹配</li> <li>? - 任何单个字符</li> <li>&quot;*&quot; - 0或者任意数量字符或者目录</li> <li>&quot;**&quot; - 0或者任意数量目录</li></ul></li> <li><p>Spring根据传入的地址，自动构建出适配于该资源的Resource实现类实例，用的是ResourceLoader</p> <blockquote><p>看起来像是简单工厂模式，其实是策略模式</p> <p>简单工厂强调的是获取创建出来的对象，用户并不了解对象的本身</p> <p>策略模式要求用户了解策略，即针对什么样的资源需要用到哪种Resource来加载</p></blockquote> <ul><li>getClassLoader</li></ul></li></ul> <img src="/assets/img/spring/image-20220425203123589.png" alt="image-20220425203123589" style="zoom:50%;"> <ul><li><p><code>DefaultResourceLoader</code></p> <ul><li>getResource</li></ul></li> <li><p>ResourceLoader并不支持Ant风格的路径解析，Spring提供了ResourcePatternResolver接口，加入了getResources方法，返回多个Resource实例，新增了一种协议前缀“classpath*:&quot;</p> <ul><li>PathMatchingResourcePatternResolver提供了ResourcePatternResolver实现，该类组合了ResourceLoader，也就是说对于继承自ResourceLoader的方法的实现会代理给该引用</li></ul></li> <li><p>ApplicationContext继承了ResourcePatternResolver接口，所以任何的ApplicationContext的实现都可以看做是一个ResourceLoader或者ResourcePatternResolver的实例</p></li> <li><p>AbstractApplicationContext继承了DefaultResourceLoader，其内部有个getResourcePatternResolver()方法，返回了PathMathingResourcePatternResolver的实例，将自己作为ResourceLoader传入，该方法在AbstractApplicationContext的构造函数中引用</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">ResourcePatternResolver</span> <span class="token function">getResourcePatternResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PathMatchingResourcePatternResolver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// AbstractApplicationContext构造函数</span>
<span class="token keyword">public</span> <span class="token class-name">AbstractApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>resourcePatternResolver <span class="token operator">=</span> <span class="token function">getResourcePatternResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="_1-5-beandefinitionreader"><a href="#_1-5-beandefinitionreader" class="header-anchor">#</a> 1.5 BeanDefinitionReader</h3> <blockquote><p>BeanDefinitionReader利用ResourceLoader或者ResourcePatternResolver将配置信息解析成一个一个的BeanDefinition</p> <p>最终借助BeanDefinitionRegistry将BeanDefinition注册到容器中</p></blockquote> <img src="/assets/img/spring/image-20220425213903721.png" alt="image-20220425213903721" style="zoom:50%;"> <ul><li>getRegistry() - 将BeanDefinition注册到BeanDefinition的注册表中【beanDefinitionMap】</li> <li>getBeanNameGenerator() - Bean名字生成器，为匿名bean生成一个name</li></ul> <img src="/assets/img/spring/image-20220425214110111.png" alt="image-20220425214110111" style="zoom:50%;"> <ul><li><p><code>AbstractBeanDefinitionReader</code></p> <ul><li>loadBeanDefinitions()方法根据用户提供的ResourceLoader类型，判断加载一个还是多个资源</li></ul></li> <li><p><code>XmlBeanDefinitionReader</code></p></li></ul> <h3 id="_1-6-beandefinitionregistry"><a href="#_1-6-beandefinitionregistry" class="header-anchor">#</a> 1.6 BeanDefinitionRegistry</h3> <img src="/assets/img/spring/image-20220425222146387.png" alt="image-20220425222146387" style="zoom:50%;"> <h3 id="_1-7-beandefinition注册流程"><a href="#_1-7-beandefinition注册流程" class="header-anchor">#</a> 1.7 BeanDefinition注册流程</h3> <ul><li><p>alreadyCreated - 一个名字列表，保存了至少创建过一次的bean的名字集合，如果这个集合不为空，走下面逻辑</p> <ul><li>锁住beanDefinitionMap</li> <li>将新增的BeanDefinition放进beanDefinitionMap</li> <li>新建一个list，将之前所有BeanDefinition的name加进去</li> <li>将新增的BeanDefinition的名字加入这个list</li> <li>用这个list覆盖之前的beanDefinitionNames</li> <li>【所以，BeanDefinitionNames是按照注册保存进去的】</li> <li>对已经注册的单例bean的名字列表【manualSingletonNames】进行更新，如果要新增的BeanDefinition的名字在这个列表里就删掉</li></ul></li> <li><p>alreadyCreated为空，说明容器是新创建的，大胆注册，从manualSingletonNames中删除这个名字</p> <p>。。。。。。。好乱！！！！！！</p></li></ul> <h3 id="_1-8-xml配置文件加载beandefinition流程"><a href="#_1-8-xml配置文件加载beandefinition流程" class="header-anchor">#</a> 1.8 xml配置文件加载BeanDefinition流程</h3> <blockquote><p>BeanDefinitionReader将DefaultListableBeanFactory【BeanDefinitionRegistry】和FileSystemXmlApplicationContext【ResourceLoader】串联到一起</p> <p>所以，BeanDefinitionReader的子类实现，组合了ResourceLoader</p></blockquote> <img src="/assets/img/spring/image-20220426145447103.png" alt="image-20220426145447103" style="zoom:50%;"> <div class="language-mermaid extra-class"><pre class="language-mermaid"><code><span class="token keyword">sequenceDiagram</span>
	FileSystemXmlApplicationContext <span class="token arrow operator">-&gt;&gt;</span> AbstractApplicationContext<span class="token operator">:</span> 调用父类构造方法，创建默认&lt;br/&gt;ResourceLoader【PathMatchingResourcePatternResolver】
	FileSystemXmlApplicationContext <span class="token arrow operator">-&gt;&gt;</span> AbstractRefreshableConfigApplicationContext<span class="token operator">:</span> 设置资源路径【configLocations】
	FileSystemXmlApplicationContext <span class="token arrow operator">-&gt;&gt;</span> AbstractApplicationContext<span class="token operator">:</span> 调用refresh<span class="token punctuation">(</span><span class="token punctuation">)</span>方法
	AbstractApplicationContext <span class="token arrow operator">-&gt;&gt;</span> AbstractApplicationContext<span class="token operator">:</span> 调用obtainFreshBeanFactory<span class="token punctuation">(</span><span class="token punctuation">)</span>方法
AbstractApplicationContext <span class="token arrow operator">-&gt;&gt;</span> AbstractRefreshableApplicationContext<span class="token operator">:</span> 调用子类refreshBeanFactory（）方法
AbstractRefreshableApplicationContext <span class="token arrow operator">-&gt;&gt;</span> AbstractRefreshableApplicationContext<span class="token operator">:</span> 创建DefaultListableBeanFactory
AbstractRefreshableApplicationContext <span class="token arrow operator">-&gt;&gt;</span> AbstractXmlApplicationContext<span class="token operator">:</span> 调用loadBeanDefinitions<span class="token text string">(beanFactory)</span>
AbstractXmlApplicationContext <span class="token arrow operator">-&gt;&gt;</span> AbstractXmlApplicationContext<span class="token operator">:</span> 创建XmlBeanDefinitionReader&lt;br/&gt;【将beanFactory当做BeanDefinitionRegistry传给XmlBeanDefinitionReader】
AbstractXmlApplicationContext <span class="token arrow operator">-&gt;&gt;</span> AbstractXmlApplicationContext<span class="token operator">:</span> 为beanDefinitionReader设置ResourceLoader&lt;br/&gt;【参数为this，也就是FileSystemXmlApplicationContext】
AbstractXmlApplicationContext <span class="token arrow operator">-&gt;&gt;</span> AbstractXmlApplicationContext<span class="token operator">:</span> 调用loadBeanDefinitions<span class="token text string">(beanDefinitionReader)</span>方法
AbstractXmlApplicationContext <span class="token arrow operator">-&gt;&gt;</span> XmlBeanDefinitionReader<span class="token operator">:</span> 调用reader的loadBeanDefinitions<span class="token text string">(configLocations)</span>方法&lt;br/&gt;至此，进入BeanDefinitionReader的流程 
</code></pre></div><h3 id="_1-9-注解配置加载beandefinition流程"><a href="#_1-9-注解配置加载beandefinition流程" class="header-anchor">#</a> 1.9 注解配置加载BeanDefinition流程</h3> <ul><li>DefaultListableBeanFactory在调用容器构造函数的时候生成的，而在xml中，是在refresh方法中的obtainFreshBeanFactory()方法中创建的，提前创建的原因是需要提前创建出一些系统内置的BeanDefinition实例</li> <li>构造函数中直接创建AnnotatedBeanDefinitionReader，并将自己作为BeanDefinitionRegistry传入，需要注意的是，AnnotationConfigApplicationContext继承了GenericApplicationContext，GenericApplicationContext又实现了BeanDefinitionRegistry接口，但是真正注册BeanDefinition的是GenericApplicationContext中的成员变量DefaultListableBeanFactory</li> <li>AnnotatedBeanDefinitionReader并不属于BeanDefinitionReader的体系，而是专门负责注解相关的BeanDefinition的注入</li> <li>入口类的Bean注册和普通Bean注册的流程不一样，入口类与系统内置的Bean一样，在构造方法中就已经生成了，而普通bean，是在refresh()方法中的invokeBeanFactoryPostProcessors(beanFactory)方法中执行的</li></ul> <p>待补充。。。。。。</p> <h2 id="_2-refresh-方法"><a href="#_2-refresh-方法" class="header-anchor">#</a> 2. Refresh()方法</h2> <h3 id="_2-1-postprocessor"><a href="#_2-1-postprocessor" class="header-anchor">#</a> 2.1 PostProcessor</h3> <blockquote><p>也是注册到Spring里的bean</p> <p>里面的方法会在特定时机被调用</p> <p>实现不改变容器或者Bean核心逻辑的情况下对Bean进行扩展</p></blockquote> <ul><li>BeanDefinitionRegistryPostProcessor</li> <li>BeanFactoryPostProcessor</li> <li>BeanPostProcessor</li></ul> <h3 id="_2-2-aware接口"><a href="#_2-2-aware接口" class="header-anchor">#</a> 2.2 Aware接口</h3> <blockquote><p>从bean里获取到的容器实例并对其进行操作</p></blockquote> <p><img src="/assets/img/spring/image-20220426170847965.png" alt="image-20220426170847965"></p> <h3 id="_2-3-事件监听器模式"><a href="#_2-3-事件监听器模式" class="header-anchor">#</a> 2.3 事件监听器模式</h3> <img src="/assets/img/spring/image-20220426173005122.png" alt="image-20220426173005122" style="zoom:50%;"> <p><strong>事件驱动模型的三大组成部分</strong></p> <ol><li>事件：ApplicationEvent
<ol><li>PayloadApplicationEvent&lt;T&gt; - 在容器内不发布任意事件的时候，容器都会自动包装成PayloadApplicationEvent类型</li></ol></li> <li>事件监听器：ApplicationListener
1.</li> <li>事件发布器：ApplicationEventPublisher、ApplicationEventMulticaster</li></ol> <h3 id="_2-4-refresh-方法流程"><a href="#_2-4-refresh-方法流程" class="header-anchor">#</a> 2.4 refresh()方法流程</h3> <h4 id="_2-4-1"><a href="#_2-4-1" class="header-anchor">#</a> 2.4.1</h4> <p>jvm</p> <p>thread</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">4/28/2022, 5:30:38 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/docs/assets/js/app.5a0d12c5.js" defer></script><script src="/docs/assets/js/2.e7fbde6b.js" defer></script><script src="/docs/assets/js/9.499b8aef.js" defer></script>
  </body>
</html>
